<!DOCTYPE html>
<html lang="zh-CN" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>锁 | 本地煮鸡:8080</title>
    <meta name="description" content="一个博客, 会记录一些技术笔记">
    <meta name="generator" content="VitePress v1.6.3">
    <link rel="preload stylesheet" href="/assets/style.BVL8E0n4.css" as="style">
    <link rel="preload stylesheet" href="/vp-icons.css" as="style">
    
    <script type="module" src="/assets/app.inDXfB1Q.js"></script>
    <link rel="preload" href="/assets/inter-roman-latin.Di8DUHzh.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/assets/chunks/theme.ejZ5Wcs9.js">
    <link rel="modulepreload" href="/assets/chunks/framework.DPDPlp3K.js">
    <link rel="modulepreload" href="/assets/mysql_lock.md.DVMZUbeu.lean.js">
    <link rel="icon" href="./img/favicon.ico">
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-132436049-1"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-132436049-1");</script>
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-5d98c3a5><!--[--><!--]--><!--[--><span tabindex="-1" data-v-0b0ada53></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-0b0ada53>Skip to content</a><!--]--><!----><header class="VPNav" data-v-5d98c3a5 data-v-ae24b3ad><div class="VPNavBar" data-v-ae24b3ad data-v-6aa21345><div class="wrapper" data-v-6aa21345><div class="container" data-v-6aa21345><div class="title" data-v-6aa21345><div class="VPNavBarTitle has-sidebar" data-v-6aa21345 data-v-1168a8e4><a class="title" href="/" data-v-1168a8e4><!--[--><!--]--><!----><span data-v-1168a8e4>本地煮鸡:8080</span><!--[--><!--]--></a></div></div><div class="content" data-v-6aa21345><div class="content-body" data-v-6aa21345><!--[--><!--]--><div class="VPNavBarSearch search" data-v-6aa21345><!--[--><!----><div id="local-search"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><span class="vp-icon DocSearch-Search-Icon"></span><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div><!--]--></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-6aa21345 data-v-dc692963><span id="main-nav-aria-label" class="visually-hidden" data-v-dc692963> Main Navigation </span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/" tabindex="0" data-v-dc692963 data-v-e56f3d57><!--[--><span data-v-e56f3d57>主页</span><!--]--></a><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-dc692963 data-v-cf11d7a2><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-cf11d7a2><span class="text" data-v-cf11d7a2><!----><span data-v-cf11d7a2>笔记</span><span class="vpi-chevron-down text-icon" data-v-cf11d7a2></span></span></button><div class="menu" data-v-cf11d7a2><div class="VPMenu" data-v-cf11d7a2 data-v-b98bc113><div class="items" data-v-b98bc113><!--[--><!--[--><div class="VPMenuLink" data-v-b98bc113 data-v-35975db6><a class="VPLink link" href="/java/" data-v-35975db6><!--[--><span data-v-35975db6>Java</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-b98bc113 data-v-35975db6><a class="VPLink link" href="/hello-world/" data-v-35975db6><!--[--><span data-v-35975db6>杂谈</span><!--]--></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-dc692963 data-v-cf11d7a2><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-cf11d7a2><span class="text" data-v-cf11d7a2><!----><span data-v-cf11d7a2>施工中笔记</span><span class="vpi-chevron-down text-icon" data-v-cf11d7a2></span></span></button><div class="menu" data-v-cf11d7a2><div class="VPMenu" data-v-cf11d7a2 data-v-b98bc113><div class="items" data-v-b98bc113><!--[--><!--[--><div class="VPMenuGroup" data-v-b98bc113 data-v-69e747b5><p class="title" data-v-69e747b5>编程语言</p><!--[--><!--[--><div class="VPMenuLink" data-v-69e747b5 data-v-35975db6><a class="VPLink link" href="/kotlin/" data-v-35975db6><!--[--><span data-v-35975db6>Kotlin</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-69e747b5 data-v-35975db6><a class="VPLink link" href="/python/" data-v-35975db6><!--[--><span data-v-35975db6>Python</span><!--]--></a></div><!--]--><!--]--></div><!--]--><!--[--><div class="VPMenuGroup" data-v-b98bc113 data-v-69e747b5><p class="title" data-v-69e747b5>后端开发技术</p><!--[--><!--[--><div class="VPMenuLink" data-v-69e747b5 data-v-35975db6><a class="VPLink link" href="/web/" data-v-35975db6><!--[--><span data-v-35975db6>Web</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-69e747b5 data-v-35975db6><a class="VPLink link" href="/spring/" data-v-35975db6><!--[--><span data-v-35975db6>Spring</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-69e747b5 data-v-35975db6><a class="VPLink link" href="/mysql/" data-v-35975db6><!--[--><span data-v-35975db6>MySQL</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-69e747b5 data-v-35975db6><a class="VPLink link" href="/redis/" data-v-35975db6><!--[--><span data-v-35975db6>Redis</span><!--]--></a></div><!--]--><!--]--></div><!--]--><!--[--><div class="VPMenuGroup" data-v-b98bc113 data-v-69e747b5><p class="title" data-v-69e747b5>学科基础</p><!--[--><!--[--><div class="VPMenuLink" data-v-69e747b5 data-v-35975db6><a class="VPLink link" href="/software-engineering/" data-v-35975db6><!--[--><span data-v-35975db6>软件工程</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-69e747b5 data-v-35975db6><a class="VPLink link" href="/algorithm/" data-v-35975db6><!--[--><span data-v-35975db6>算法</span><!--]--></a></div><!--]--><!--]--></div><!--]--><!--[--><div class="VPMenuGroup" data-v-b98bc113 data-v-69e747b5><p class="title" data-v-69e747b5>机器学习</p><!--[--><!--[--><div class="VPMenuLink" data-v-69e747b5 data-v-35975db6><a class="VPLink link" href="/artificial-intelligence/" data-v-35975db6><!--[--><span data-v-35975db6>人工智能</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-69e747b5 data-v-35975db6><a class="VPLink link" href="/deep-learning/" data-v-35975db6><!--[--><span data-v-35975db6>深度学习</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-69e747b5 data-v-35975db6><a class="VPLink link" href="/recommender-systems/" data-v-35975db6><!--[--><span data-v-35975db6>推荐系统</span><!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-69e747b5 data-v-35975db6><a class="VPLink link" href="/quantitative-methods-for-DA-AI/" data-v-35975db6><!--[--><span data-v-35975db6>数据分析与人工智能定量分析</span><!--]--></a></div><!--]--><!--]--></div><!--]--><!--[--><div class="VPMenuGroup" data-v-b98bc113 data-v-69e747b5><p class="title" data-v-69e747b5>大数据</p><!--[--><!--[--><div class="VPMenuLink" data-v-69e747b5 data-v-35975db6><a class="VPLink link" href="/hadoop/" data-v-35975db6><!--[--><span data-v-35975db6>Hadoop</span><!--]--></a></div><!--]--><!--]--></div><!--]--><!--[--><div class="VPMenuGroup" data-v-b98bc113 data-v-69e747b5><p class="title" data-v-69e747b5>Android Frameworks</p><!--[--><!--[--><div class="VPMenuLink" data-v-69e747b5 data-v-35975db6><a class="VPLink link" href="/framework/" data-v-35975db6><!--[--><span data-v-35975db6>Framework</span><!--]--></a></div><!--]--><!--]--></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><a class="VPLink link vp-external-link-icon VPNavBarMenuLink" href="https://gitee.com/zweirm/" target="_blank" rel="noreferrer" tabindex="0" data-v-dc692963 data-v-e56f3d57><!--[--><span data-v-e56f3d57>码云</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/about/" tabindex="0" data-v-dc692963 data-v-e56f3d57><!--[--><span data-v-e56f3d57>关于</span><!--]--></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-6aa21345 data-v-6c893767><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-6c893767 data-v-5337faa4 data-v-1d5665e3><span class="check" data-v-1d5665e3><span class="icon" data-v-1d5665e3><!--[--><span class="vpi-sun sun" data-v-5337faa4></span><span class="vpi-moon moon" data-v-5337faa4></span><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-6aa21345 data-v-0394ad82 data-v-7bc22406><!--[--><a class="VPSocialLink no-icon" href="ZweiRm/localhost-8080.github.io" aria-label="github" target="_blank" rel="noopener" data-v-7bc22406 data-v-bd121fe5><span class="vpi-social-github"></span></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-6aa21345 data-v-bb2aa2f0 data-v-cf11d7a2><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-cf11d7a2><span class="vpi-more-horizontal icon" data-v-cf11d7a2></span></button><div class="menu" data-v-cf11d7a2><div class="VPMenu" data-v-cf11d7a2 data-v-b98bc113><!----><!--[--><!--[--><!----><div class="group" data-v-bb2aa2f0><div class="item appearance" data-v-bb2aa2f0><p class="label" data-v-bb2aa2f0>Appearance</p><div class="appearance-action" data-v-bb2aa2f0><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-bb2aa2f0 data-v-5337faa4 data-v-1d5665e3><span class="check" data-v-1d5665e3><span class="icon" data-v-1d5665e3><!--[--><span class="vpi-sun sun" data-v-5337faa4></span><span class="vpi-moon moon" data-v-5337faa4></span><!--]--></span></span></button></div></div></div><div class="group" data-v-bb2aa2f0><div class="item social-links" data-v-bb2aa2f0><div class="VPSocialLinks social-links-list" data-v-bb2aa2f0 data-v-7bc22406><!--[--><a class="VPSocialLink no-icon" href="ZweiRm/localhost-8080.github.io" aria-label="github" target="_blank" rel="noopener" data-v-7bc22406 data-v-bd121fe5><span class="vpi-social-github"></span></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-6aa21345 data-v-e5dd9c1c><span class="container" data-v-e5dd9c1c><span class="top" data-v-e5dd9c1c></span><span class="middle" data-v-e5dd9c1c></span><span class="bottom" data-v-e5dd9c1c></span></span></button></div></div></div></div><div class="divider" data-v-6aa21345><div class="divider-line" data-v-6aa21345></div></div></div><!----></header><div class="VPLocalNav has-sidebar empty" data-v-5d98c3a5 data-v-a6f0e41e><div class="container" data-v-a6f0e41e><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-a6f0e41e><span class="vpi-align-left menu-icon" data-v-a6f0e41e></span><span class="menu-text" data-v-a6f0e41e>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-a6f0e41e data-v-8a42e2b4><button data-v-8a42e2b4>Return to top</button><!----></div></div></div><aside class="VPSidebar" data-v-5d98c3a5 data-v-319d5ca6><div class="curtain" data-v-319d5ca6></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-319d5ca6><span class="visually-hidden" id="sidebar-aria-label" data-v-319d5ca6> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="no-transition group" data-v-c40bc020><section class="VPSidebarItem level-0 is-link" data-v-c40bc020 data-v-b3fd67f8><div class="item" tabindex="0" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/mysql/index.html" data-v-b3fd67f8><!--[--><h2 class="text" data-v-b3fd67f8>MySQL</h2><!--]--></a><!----></div><div class="items" data-v-b3fd67f8><!--[--><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/mysql/transaction.html" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>事务</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/mysql/indices.html" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>索引</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/mysql/lock.html" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>锁</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/mysql/divide.html" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>分库分表</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/mysql/references.html" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>参考文献或资料</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-5d98c3a5 data-v-1428d186><div class="VPDoc has-sidebar has-aside" data-v-1428d186 data-v-39a288b8><!--[--><!--]--><div class="container" data-v-39a288b8><div class="aside" data-v-39a288b8><div class="aside-curtain" data-v-39a288b8></div><div class="aside-container" data-v-39a288b8><div class="aside-content" data-v-39a288b8><div class="VPDocAside" data-v-39a288b8 data-v-3f215769><!--[--><!--]--><!--[--><!--]--><nav aria-labelledby="doc-outline-aria-label" class="VPDocAsideOutline" data-v-3f215769 data-v-a5bbad30><div class="content" data-v-a5bbad30><div class="outline-marker" data-v-a5bbad30></div><div aria-level="2" class="outline-title" id="doc-outline-aria-label" role="heading" data-v-a5bbad30>On this page</div><ul class="VPDocOutlineItem root" data-v-a5bbad30 data-v-b933a997><!--[--><!--]--></ul></div></nav><!--[--><!--]--><div class="spacer" data-v-3f215769></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-39a288b8><div class="content-container" data-v-39a288b8><!--[--><!--]--><main class="main" data-v-39a288b8><div style="position:relative;" class="vp-doc _mysql_lock" data-v-39a288b8><div><h1 id="锁" tabindex="-1">锁 <a class="header-anchor" href="#锁" aria-label="Permalink to &quot;锁&quot;">​</a></h1><p>为了解决并发操作可能会出现的问题，MySQL 提供了锁机制。根据加锁范围，分为全局锁、表级锁和行级锁。</p><h2 id="全局锁" tabindex="-1">全局锁 <a class="header-anchor" href="#全局锁" aria-label="Permalink to &quot;全局锁&quot;">​</a></h2><p>使用命令 <code>FLUSH TABLES WITH READ LOCK</code> 让整个库处于只读状态。之后其他线程的 DDL(数据定义语言，包括创建表、修改表等)、DML(数据操作语言，包括增、删、改)和更新类的事务的提交语句会被阻塞。<br> 使用 <code>UNLOCK TABLES</code> 解锁。</p><h3 id="使用场景" tabindex="-1">使用场景 <a class="header-anchor" href="#使用场景" aria-label="Permalink to &quot;使用场景&quot;">​</a></h3><p>当在进行全库逻辑备份（所有记录查找并保存到文本）时，可以考虑使用全局锁。</p><ul><li>必要性<br> 可能会发生数据不一致。在不加全局锁的情形下，因为不同表之间执行顺序不同备份时间就不同。若一张表在备份时间差内进行了更新操作，则它会与已经备份的关联表数据不一致。<div class="tip custom-block"><p class="custom-block-title">一个有限制条件的解决方案</p><p>可以利用可重复读的事务来解决。在支持事务的引擎里，比如 InnoDB 提供了逻辑备份工具 mysqldump. 使用参数 <code>-single-transaction</code> 来使用它时会在导入数据前启动一个事务，保证视图的一致性。且由于多版本并发控制 （MVCC），在备份过程中可以进行更新操作。</p></div></li><li>缺点 <ul><li>在主库备份时，FTWRL 会使得主库不能执行更新操作，业务停摆；</li><li>若是读写分离的主从库模式，从库备份时，从库不能执行主库同步的 binglog 导致主从延迟。</li></ul></li></ul><div class="warning custom-block"><p class="custom-block-title">关于设置全局只读的解决方法</p><p>使用 <code>set global readonly=true</code> 也可以使得整个库处于只读的状态，但会带来一些问题：</p><ul><li>在一些主从库中，会使用 readonly 作为逻辑判断是否是从库；</li><li>当客户端发生异常断开时，readonly 不会改变库的状态，依旧保持只读会导致库处于长时间不可写状态。 FTWRL 在发生断开时会自动释放全局锁，让库恢复可以正常更新的状态。</li></ul></div><h2 id="表级锁" tabindex="-1">表级锁 <a class="header-anchor" href="#表级锁" aria-label="Permalink to &quot;表级锁&quot;">​</a></h2><p>表锁分为两种：表锁和元数据锁。</p><h3 id="表锁" tabindex="-1">表锁 <a class="header-anchor" href="#表锁" aria-label="Permalink to &quot;表锁&quot;">​</a></h3><p>使用 <code>LOCK TABLES $table READ/WRITE</code> 来对表进行锁定。它使用 <code>UNLOCK TABLES</code> 主动解锁或在客户端断开连接时自动释放锁。它不仅限制别的线程的读或写，也限制本线程的操作：</p><ul><li>线程 A 对某表添加读锁，线程 A 和其他线程都不能对表进行写操作。同时线程 A 不可以读写其他未加锁的表；</li><li>线程 A 对某表添加写锁，线程 A 可以对表进行写操作，其他线程对表读写都阻塞；</li></ul><p>理解为共享读锁，独占写锁。表锁在没有更细粒度的锁出现前，是最常用的并发处理机制。</p><h3 id="元数据锁-metadata-lock" tabindex="-1">元数据锁 (Metadata Lock) <span class="VPBadge tip"><!--[-->MySQL 5.5+<!--]--></span> <a class="header-anchor" href="#元数据锁-metadata-lock" aria-label="Permalink to &quot;元数据锁 (Metadata Lock) &lt;Badge text=&quot;MySQL 5.5+&quot;/&gt;&quot;">​</a></h3><p>元数据锁会在一个表被访问时自动加锁而不需要显示使用，是一个 Server 层的锁。它可以保证读写的正确性。MDL 在语句开始时申请，事务结束后释放。</p><ul><li>当一个表在进行增删改查时会添加读锁，此时所有线程都可以正常读取元数据，不影响增删改查。（读锁之间不互斥，多个线程可以对同一张表进行增删改查）</li><li>当一个表正在进行结构更改操作时加写锁，只有拥有锁的线程可以读写元数据，其他线程不能执行任何操作。（写锁与读锁、写锁与写锁互斥，保证结构变更安全性）</li></ul><p>申请 MDL 的操作会形成一个队列，其中写锁优先级高于读锁。所以当一个写锁处于阻塞时，当前和后续所有操作都会被阻塞。所以情况如：事务 A 的查询操作触发 MDL 读锁，事务 B 包含 DDL 语句被阻塞，事务 C 有查询语句，但是因为优先级也被阻塞。意味着后续任何操作都会被阻塞。<br> 当一个事务拿到 MDL 后，只有当事务结束时才会释放锁。如果事务包含 DDL，这样它会在 DDL 执行前隐式提交事务以保障 DDL 处于一个单独的事务中，这时也会释放 MDL。</p><p><strong>解决方案</strong></p><ul><li>解决长事务。查询 information_schema 库中的 innodb_trx 表，若要执行 DDL 的表正好在长事务，可以暂停 DDL 或者 kill 长事务。</li><li>如果目标表是热点表，就在 DDL 中设置超时时间，在规定时间内拿到 MDL 写锁即执行，拿不到则放弃。后续重试。</li></ul><div class="language-sql vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ALTER</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> TABLE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tbl_name </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">NOWAIT</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> column ...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ALTER</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> TABLE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tbl_name WAIT N </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> column ...</span></span></code></pre></div><h2 id="行级锁" tabindex="-1">行级锁 <a class="header-anchor" href="#行级锁" aria-label="Permalink to &quot;行级锁&quot;">​</a></h2><p>行级锁由引擎实现，MyISAM 不支持行级锁。对于同一行记录，当事务 A 和事务 B 都想更新它时，必须等事务 A 操作完成后 B 才执行。</p><h3 id="两段锁" tabindex="-1">两段锁 <a class="header-anchor" href="#两段锁" aria-label="Permalink to &quot;两段锁&quot;">​</a></h3><p>行锁在需要时被加，事务结束后释放。当一个事务需要锁定多个行时，应当吧最可能造成冲突和影响并发度的锁向后放，从而减少一次操作中锁定共享数据的时间，提升效率。</p><h3 id="死锁检测" tabindex="-1">死锁检测 <a class="header-anchor" href="#死锁检测" aria-label="Permalink to &quot;死锁检测&quot;">​</a></h3><p>当不同线程出现循环资源依赖时，每个线程都在等其他线程释放资源，进入死锁状态。为了避免死锁，有两种方法：</p><ul><li>通过设置参数 <code>innodb_lock_wait_timeout</code> 来设置超时，如果等待超过预定时间则放弃。超时时间不容易控制，默认为 50 秒，但一般对于在线服务来说这个时间；如果设置过短，对于短等待事务不合理；</li><li>通过设置参数 <code>innodb_deadlock_detect</code> 为 <code>on</code> 来开启死锁检测，当发现死锁后主动回滚其中一个事务，让其他事务继续。死锁检测的操作是 $O(n^2)$ 级别的。会造成 CPU 利用率高。<br> 解决方案： <ul><li>如果能保证业务不会出现死锁，临时关闭死锁检测。但可能带来大量超时，业务有损。</li><li>控制并发度。编写中间件，或者修改 MySQL 源码，使得同行更新在进入引擎前进行排队。</li><li>业务进行逻辑分段。</li></ul></li></ul></div></div></main><footer class="VPDocFooter" data-v-39a288b8 data-v-e257564d><!--[--><!--]--><div class="edit-info" data-v-e257564d><div class="edit-link" data-v-e257564d><a class="VPLink link vp-external-link-icon no-icon edit-link-button" href="https://github.com/ZweiRm/localhost-8080.github.io" target="_blank" rel="noreferrer" data-v-e257564d><!--[--><span class="vpi-square-pen edit-link-icon" data-v-e257564d></span> 请帮助我改善此页面!<!--]--></a></div><!----></div><nav class="prev-next" aria-labelledby="doc-footer-aria-label" data-v-e257564d><span class="visually-hidden" id="doc-footer-aria-label" data-v-e257564d>Pager</span><div class="pager" data-v-e257564d><a class="VPLink link pager-link prev" href="/mysql/indices.html" data-v-e257564d><!--[--><span class="desc" data-v-e257564d>Previous page</span><span class="title" data-v-e257564d>索引</span><!--]--></a></div><div class="pager" data-v-e257564d><a class="VPLink link pager-link next" href="/mysql/divide.html" data-v-e257564d><!--[--><span class="desc" data-v-e257564d>Next page</span><span class="title" data-v-e257564d>分库分表</span><!--]--></a></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><footer class="VPFooter has-sidebar" data-v-5d98c3a5 data-v-e315a0ad><div class="container" data-v-e315a0ad><p class="message" data-v-e315a0ad>本作品由<a rel="contributors" target="_blank" href="https://github.com/ZweiRm/localhost-8080.github.io/graphs/contributors"><img style="display:inline" alt="GitHub contributors" src="https://img.shields.io/github/contributors/ZweiRm/localhost-8080.github.io.svg?label=%E8%B4%A1%E7%8C%AE%E8%80%85&logo=github&logoColor=3EAF7C&style=social"></a>创作，采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。<div style="display: flex; justify-content: center; align-items: center;"><a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="/img/licence.png" /></a></div></p><p class="copyright" data-v-e315a0ad>Copyright © 2018-2025 localhost-8080.io</p></div></footer><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"about_index.md\":\"CoX9ybzS\",\"algorithm_ds-001.md\":\"C14m5XBU\",\"algorithm_ds-002.md\":\"BvM8Qvc9\",\"algorithm_ds-003.md\":\"BBfrNpmg\",\"algorithm_dynamic-programming.md\":\"CTbpjg75\",\"algorithm_index.md\":\"DRjskFQf\",\"artificial-intelligence_index.md\":\"C8nkoNs4\",\"artificial-intelligence_search-strategies.md\":\"BMooYhLX\",\"c_constant-variable-and-data-type.md\":\"BeU1DXmk\",\"c_index.md\":\"CynNHD2B\",\"deep-learning_index.md\":\"Bg65frW7\",\"deep-learning_logistic-regression-as-a-neural-network.md\":\"ATdJCjiq\",\"deep-learning_python-and-vectorization.md\":\"CZqfqeSZ\",\"framework_activity-launching-process.md\":\"Bbjtot6g\",\"framework_container.md\":\"rq_hER08\",\"framework_index.md\":\"DVVqEh1H\",\"framework_performtraversal.md\":\"CvV1H9tO\",\"hadoop_index.md\":\"BK_KmJge\",\"hello-world_array-and-linked-list.md\":\"BIgP912U\",\"hello-world_binary-search.md\":\"CVEtgeQC\",\"hello-world_building-a-vuepress-powered-blog.md\":\"BOZBWDrp\",\"hello-world_computing-machinery-and-intelligence.md\":\"Cma-37JJ\",\"hello-world_index.md\":\"B6zkg25_\",\"hello-world_setup-a-server-manually.md\":\"bq26ezae\",\"hello-world_the-right-way-doing-research.md\":\"DlN3-q49\",\"hello-world_todo.md\":\"DQ8Ha4In\",\"index.md\":\"BTJx9vDj\",\"java_api-introduction.md\":\"Bx_-Xe87\",\"java_api-io.md\":\"D3f8gGMY\",\"java_api-lang.md\":\"ArFaPXpi\",\"java_api-lang2.md\":\"rpLCjXPv\",\"java_api-util.md\":\"CcGXVKZ8\",\"java_api-util2.md\":\"CAIPy-_H\",\"java_api-util3.md\":\"1Tfts_rl\",\"java_grammars.md\":\"zLed9nyB\",\"java_index.md\":\"CIXjIqYW\",\"java_jvm.md\":\"D9gQYF5c\",\"java_object-oriented.md\":\"Cgd2kYGT\",\"java_references.md\":\"DWqxUTL1\",\"kotlin_index.md\":\"B36UAcis\",\"math_index.md\":\"TMYvKy1-\",\"math_multivariate-function-differential.md\":\"B8pnNYa2\",\"mysql_divide.md\":\"C5Hd8uas\",\"mysql_index.md\":\"Brm_-Nwm\",\"mysql_indices.md\":\"C4Ri8wDz\",\"mysql_lock.md\":\"DVMZUbeu\",\"mysql_question.md\":\"Bfa7mnaW\",\"mysql_references.md\":\"BaxZTZml\",\"mysql_transaction.md\":\"zssWNHH7\",\"python_grammar.md\":\"Bkj9YlUs\",\"python_index.md\":\"DAE2aHEc\",\"quantitative-methods-for-da-ai_index.md\":\"BPYpwYa2\",\"recommender-systems_index.md\":\"Di994w-a\",\"recommender-systems_introduction.md\":\"DP92YrM_\",\"redis_cache.md\":\"9VKeIHCi\",\"redis_cluster.md\":\"Dqn0VxC-\",\"redis_data-structure.md\":\"Y0-w7cWN\",\"redis_index.md\":\"ZKMN8REL\",\"redis_persistence.md\":\"Bjt3Jbc_\",\"software-engineering_index.md\":\"NlNK3OMf\",\"software-engineering_software-process.md\":\"Ca9etcAQ\",\"spring_index.md\":\"CBR-9Wp8\",\"spring_ioc.md\":\"DlxZ7thF\",\"spring_overall.md\":\"neo_UzCl\",\"spring_references.md\":\"Bknd6Dix\",\"web_http.md\":\"DoRJ1OiH\",\"web_index.md\":\"DnPWKeWH\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"zh-CN\",\"dir\":\"ltr\",\"title\":\"本地煮鸡:8080\",\"description\":\"一个博客, 会记录一些技术笔记\",\"base\":\"/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"nav\":[{\"text\":\"主页\",\"link\":\"/\"},{\"text\":\"笔记\",\"items\":[{\"text\":\"Java\",\"link\":\"/java/\"},{\"text\":\"杂谈\",\"link\":\"/hello-world/\"}]},{\"text\":\"施工中笔记\",\"items\":[{\"text\":\"编程语言\",\"items\":[{\"text\":\"Kotlin\",\"link\":\"/kotlin/\"},{\"text\":\"Python\",\"link\":\"/python/\"}]},{\"text\":\"后端开发技术\",\"items\":[{\"text\":\"Web\",\"link\":\"/web/\"},{\"text\":\"Spring\",\"link\":\"/spring/\"},{\"text\":\"MySQL\",\"link\":\"/mysql/\"},{\"text\":\"Redis\",\"link\":\"/redis/\"}]},{\"text\":\"学科基础\",\"items\":[{\"text\":\"软件工程\",\"link\":\"/software-engineering/\"},{\"text\":\"算法\",\"link\":\"/algorithm/\"}]},{\"text\":\"机器学习\",\"items\":[{\"text\":\"人工智能\",\"link\":\"/artificial-intelligence/\"},{\"text\":\"深度学习\",\"link\":\"/deep-learning/\"},{\"text\":\"推荐系统\",\"link\":\"/recommender-systems/\"},{\"text\":\"数据分析与人工智能定量分析\",\"link\":\"/quantitative-methods-for-DA-AI/\"}]},{\"text\":\"大数据\",\"items\":[{\"text\":\"Hadoop\",\"link\":\"/hadoop/\"}]},{\"text\":\"Android Frameworks\",\"items\":[{\"text\":\"Framework\",\"link\":\"/framework/\"}]}]},{\"text\":\"码云\",\"link\":\"https://gitee.com/zweirm/\"},{\"text\":\"关于\",\"link\":\"/about/\"}],\"sidebar\":{\"/java/\":[{\"text\":\"Java\",\"link\":\"java/index\",\"items\":[{\"text\":\"语法\",\"link\":\"java/grammars\"},{\"text\":\"面向对象\",\"link\":\"java/object-oriented\"},{\"text\":\"API-介绍\",\"link\":\"java/API-introduction\"},{\"text\":\"API-语言基础类库\",\"link\":\"java/API-lang\"},{\"text\":\"API-语言基础类库2\",\"link\":\"java/API-lang2\"},{\"text\":\"API-工具类库\",\"link\":\"java/API-util\"},{\"text\":\"API-工具类库2\",\"link\":\"java/API-util2\"},{\"text\":\"API-工具类库3\",\"link\":\"java/API-util3\"},{\"text\":\"API-输入输出类库\",\"link\":\"java/API-io\"},{\"text\":\"Java 虚拟机\",\"link\":\"java/jvm\"},{\"text\":\"参考文献嚯资料\",\"link\":\"java/references\"}]}],\"/hello-world/\":[{\"text\":\"Hello World!\",\"link\":\"hello-world/index\",\"items\":[{\"text\":\"Computing Machinery and Intelligence\",\"link\":\"hello-world/computing-machinery-and-intelligence\"},{\"text\":\"学术研究的正确姿势\",\"link\":\"hello-world/the-right-way-doing-research\"},{\"text\":\"搭建一个基于 VuePress 的博客\",\"link\":\"hello-world/building-a-vuepress-powered-blog\"},{\"text\":\"手动配置一台服务器\",\"link\":\"hello-world/setup-a-server-manually\"},{\"text\":\"数组和链表\",\"link\":\"hello-world/array-and-linked-list\"},{\"text\":\"TODO\",\"link\":\"hello-world/TODO\"}]}],\"/kotlin/\":[{\"text\":\"Kotlin\",\"link\":\"kotlin/index\"}],\"/python/\":[{\"text\":\"Python\",\"link\":\"python/index\",\"items\":[{\"text\":\"语法\",\"link\":\"python/grammar\"}]}],\"/c/\":[{\"text\":\"C\",\"link\":\"c/index\",\"items\":[{\"text\":\"常量与数据结构\",\"link\":\"c/constant-variable-and-data-type\"}]}],\"/web/\":[{\"text\":\"Web\",\"link\":\"web/index\",\"items\":[{\"text\":\"HTTP\",\"link\":\"web/HTTP\"}]}],\"/spring/\":[{\"text\":\"Spring\",\"link\":\"spring/index\",\"items\":[{\"text\":\"总览\",\"link\":\"spring/overall\"},{\"text\":\"IoC\",\"link\":\"spring/ioc\"},{\"text\":\"参考文献与资料\",\"link\":\"spring/references\"}]}],\"/redis/\":[{\"text\":\"Redis\",\"link\":\"redis/index\",\"items\":[{\"text\":\"缓存\",\"link\":\"redis/cache\"},{\"text\":\"集群\",\"link\":\"redis/cluster\"},{\"text\":\"数据结构\",\"link\":\"redis/data-structure\"},{\"text\":\"持久化\",\"link\":\"redis/persistence\"}]}],\"/deep-learning/\":[{\"text\":\"Deep Learning\",\"link\":\"deep-learning/index\",\"items\":[{\"text\":\"Logistic Regression as a Neural Network\",\"link\":\"deep-learning/logistic-regression-as-a-neural-network\"},{\"text\":\"Python and Vectorization\",\"link\":\"deep-learning/python-and-vectorization\"}]}],\"/quantitative-methods-for-DA-AI/\":[{\"text\":\"Quantitative Methods for DA and AI\",\"link\":\"quantitative-methods-for-DA-AI/index\"}],\"/artificial-intelligence/\":[{\"text\":\"Artificial Intelligence\",\"link\":\"artificial-intelligence/index\",\"items\":[{\"text\":\"Search Strategies\",\"link\":\"artificial-intelligence/search-strategies\"}]}],\"/software-engineering/\":[{\"text\":\"软件工程\",\"link\":\"software-engineering/index\",\"items\":[{\"text\":\"软件过程\",\"link\":\"software-engineering/software-process\"}]}],\"/math/\":[{\"text\":\"数学\",\"link\":\"math/index\",\"items\":[{\"text\":\"多元函数微分\",\"link\":\"math/multivariate-function-differential\"}]}],\"/algorithm/\":[{\"text\":\"算法\",\"link\":\"algorithm/index\",\"items\":[{\"text\":\"算法 01\",\"link\":\"algorithm/ds-001\"},{\"text\":\"算法 02\",\"link\":\"algorithm/ds-002\"},{\"text\":\"算法 03\",\"link\":\"algorithm/ds-003\"},{\"text\":\"动态规划\",\"link\":\"algorithm/dynamic-programming\"}]}],\"/recommender-systems/\":[{\"text\":\"Recommender Systems\",\"link\":\"recommender-systems/index\",\"items\":[{\"text\":\"Introduction\",\"link\":\"recommender-systems/introduction\"}]}],\"/mysql/\":[{\"text\":\"MySQL\",\"link\":\"mysql/index\",\"items\":[{\"text\":\"事务\",\"link\":\"mysql/transaction\"},{\"text\":\"索引\",\"link\":\"mysql/indices\"},{\"text\":\"锁\",\"link\":\"mysql/lock\"},{\"text\":\"分库分表\",\"link\":\"mysql/divide\"},{\"text\":\"参考文献或资料\",\"link\":\"mysql/references\"}]}],\"/hadoop/\":[{\"text\":\"Hadoop\",\"link\":\"hadoop/index\"}],\"/framework/\":[{\"text\":\"Android Frameworks\",\"link\":\"framework/index\",\"items\":[{\"text\":\"Activity 启动流程\",\"link\":\"framework/activity-launching-process\"},{\"text\":\"performTraversal\",\"link\":\"framework/performTraversal\"},{\"text\":\"Android 12 容器层级\",\"link\":\"framework/container\"}]}]},\"socialLinks\":[{\"icon\":\"github\",\"link\":\"ZweiRm/localhost-8080.github.io\"}],\"footer\":{\"message\":\"本作品由<a rel=\\\"contributors\\\" target=\\\"_blank\\\" href=\\\"https://github.com/ZweiRm/localhost-8080.github.io/graphs/contributors\\\"><img style=\\\"display:inline\\\" alt=\\\"GitHub contributors\\\" src=\\\"https://img.shields.io/github/contributors/ZweiRm/localhost-8080.github.io.svg?label=%E8%B4%A1%E7%8C%AE%E8%80%85&logo=github&logoColor=3EAF7C&style=social\\\"></a>创作，采用<a rel=\\\"license\\\" href=\\\"http://creativecommons.org/licenses/by-nc-sa/4.0/\\\">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可。<div style=\\\"display: flex; justify-content: center; align-items: center;\\\"><a rel=\\\"license\\\" href=\\\"http://creativecommons.org/licenses/by-nc-sa/4.0/\\\"><img alt=\\\"知识共享许可协议\\\" style=\\\"border-width:0\\\" src=\\\"/img/licence.png\\\" /></a></div>\",\"copyright\":\"Copyright © 2018-2025 localhost-8080.io\"},\"editLink\":{\"text\":\"请帮助我改善此页面!\",\"pattern\":\"https://github.com/ZweiRm/localhost-8080.github.io\"},\"search\":{\"provider\":\"local\",\"options\":{\"locales\":{\"zh\":{\"translations\":{\"button\":{\"buttonText\":\"搜索文档\",\"buttonAriaLabel\":\"搜索文档\"},\"modal\":{\"noResultsText\":\"无法找到相关结果\",\"resetButtonTitle\":\"清除查询条件\",\"footer\":{\"selectText\":\"选择\",\"navigateText\":\"切换\"}}}}}}}},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":false}");</script>
    
  </body>
</html>