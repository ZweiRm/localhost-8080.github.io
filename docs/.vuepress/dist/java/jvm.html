<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Java 虚拟机 | 本地煮鸡:8080</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="一个博客, 大概会记录一些技术笔记">
    <meta property="article:modified_time" content="null">
    <meta property="og:site_name" content="本地煮鸡:8080">
    <meta property="og:title" content="Java 虚拟机">
    <meta property="og:type" content="article">
    <meta property="og:url" content="/java/jvm.html">
    <meta name="twitter:title" content="Java 虚拟机">
    <meta name="twitter:url" content="/java/jvm.html">
    
    <link rel="preload" href="/assets/css/0.styles.ecc20c62.css" as="style"><link rel="preload" href="/assets/js/app.5cefb728.js" as="script"><link rel="preload" href="/assets/js/3.5e213994.js" as="script"><link rel="preload" href="/assets/js/38.f75bb434.js" as="script"><link rel="preload" href="/assets/js/6.99f29953.js" as="script"><link rel="preload" href="/assets/js/5.612dc22d.js" as="script"><link rel="prefetch" href="/assets/js/10.3adfe19d.js"><link rel="prefetch" href="/assets/js/11.09b759ca.js"><link rel="prefetch" href="/assets/js/12.58c3c31a.js"><link rel="prefetch" href="/assets/js/13.752bd570.js"><link rel="prefetch" href="/assets/js/14.181f1bcf.js"><link rel="prefetch" href="/assets/js/15.38c74136.js"><link rel="prefetch" href="/assets/js/16.95f8f4d9.js"><link rel="prefetch" href="/assets/js/17.54b56cba.js"><link rel="prefetch" href="/assets/js/18.d84b5664.js"><link rel="prefetch" href="/assets/js/19.87837777.js"><link rel="prefetch" href="/assets/js/20.a66eeff5.js"><link rel="prefetch" href="/assets/js/21.c56ff9e1.js"><link rel="prefetch" href="/assets/js/22.ccad7158.js"><link rel="prefetch" href="/assets/js/23.7cc6f7fb.js"><link rel="prefetch" href="/assets/js/24.38388c2d.js"><link rel="prefetch" href="/assets/js/25.77281d9f.js"><link rel="prefetch" href="/assets/js/26.cff24e7f.js"><link rel="prefetch" href="/assets/js/27.5aea81c0.js"><link rel="prefetch" href="/assets/js/28.d2c96cf0.js"><link rel="prefetch" href="/assets/js/29.13565ef4.js"><link rel="prefetch" href="/assets/js/30.4fb7780f.js"><link rel="prefetch" href="/assets/js/31.7cb8d683.js"><link rel="prefetch" href="/assets/js/32.92d57a10.js"><link rel="prefetch" href="/assets/js/33.f71d4765.js"><link rel="prefetch" href="/assets/js/34.a13839b8.js"><link rel="prefetch" href="/assets/js/35.451420fc.js"><link rel="prefetch" href="/assets/js/36.7afede1c.js"><link rel="prefetch" href="/assets/js/37.98b43b09.js"><link rel="prefetch" href="/assets/js/39.ec539916.js"><link rel="prefetch" href="/assets/js/4.4456b9a5.js"><link rel="prefetch" href="/assets/js/40.90511417.js"><link rel="prefetch" href="/assets/js/41.d0d2b5c2.js"><link rel="prefetch" href="/assets/js/42.8e6a983a.js"><link rel="prefetch" href="/assets/js/43.dd175bc4.js"><link rel="prefetch" href="/assets/js/44.c8013700.js"><link rel="prefetch" href="/assets/js/45.71f21be7.js"><link rel="prefetch" href="/assets/js/46.9d57ebbf.js"><link rel="prefetch" href="/assets/js/47.9187daec.js"><link rel="prefetch" href="/assets/js/48.42721d77.js"><link rel="prefetch" href="/assets/js/49.0b83e96b.js"><link rel="prefetch" href="/assets/js/50.a6923b34.js"><link rel="prefetch" href="/assets/js/51.6c6078d0.js"><link rel="prefetch" href="/assets/js/52.665f7bc4.js"><link rel="prefetch" href="/assets/js/53.8c7eab7b.js"><link rel="prefetch" href="/assets/js/54.87960688.js"><link rel="prefetch" href="/assets/js/55.c6569a40.js"><link rel="prefetch" href="/assets/js/56.8f75e778.js"><link rel="prefetch" href="/assets/js/57.562e9d38.js"><link rel="prefetch" href="/assets/js/58.514413e5.js"><link rel="prefetch" href="/assets/js/59.3eb9cee1.js"><link rel="prefetch" href="/assets/js/60.655b586f.js"><link rel="prefetch" href="/assets/js/61.191e4d0a.js"><link rel="prefetch" href="/assets/js/62.92cdef23.js"><link rel="prefetch" href="/assets/js/63.d233b148.js"><link rel="prefetch" href="/assets/js/64.cfca67d1.js"><link rel="prefetch" href="/assets/js/65.2c27de1a.js"><link rel="prefetch" href="/assets/js/66.d97c5ea4.js"><link rel="prefetch" href="/assets/js/67.98709f71.js"><link rel="prefetch" href="/assets/js/68.8d32d42c.js"><link rel="prefetch" href="/assets/js/69.70eedef4.js"><link rel="prefetch" href="/assets/js/7.fc3990b3.js"><link rel="prefetch" href="/assets/js/70.5c51f62e.js"><link rel="prefetch" href="/assets/js/8.8634021e.js"><link rel="prefetch" href="/assets/js/9.b00a2bb6.js"><link rel="prefetch" href="/assets/js/vendors~flowchart.543d9c9f.js">
    <link rel="stylesheet" href="/assets/css/0.styles.ecc20c62.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">本地煮鸡:8080</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="笔记" class="dropdown-title"><span class="title">笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="笔记" class="mobile-dropdown-title"><span class="title">笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/java/" class="nav-link router-link-active">
  Java
</a></li><li class="dropdown-item"><!----> <a href="/hello-world/" class="nav-link">
  杂谈
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="施工中笔记" class="dropdown-title"><span class="title">施工中笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="施工中笔记" class="mobile-dropdown-title"><span class="title">施工中笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          编程语言
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/kotlin/" class="nav-link">
  Kotlin
</a></li><li class="dropdown-subitem"><a href="/python/" class="nav-link">
  Python
</a></li></ul></li><li class="dropdown-item"><h4>
          后端开发技术
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/web/" class="nav-link">
  Web
</a></li><li class="dropdown-subitem"><a href="/spring/" class="nav-link">
  Spring
</a></li><li class="dropdown-subitem"><a href="/mysql/" class="nav-link">
  MySQL
</a></li><li class="dropdown-subitem"><a href="/redis/" class="nav-link">
  Redis
</a></li><li class="dropdown-subitem"><a href="/big-data/" class="nav-link">
  大数据
</a></li></ul></li><li class="dropdown-item"><h4>
          学科基础
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/software-engineering/" class="nav-link">
  软件工程
</a></li><li class="dropdown-subitem"><a href="/algorithm/" class="nav-link">
  算法
</a></li></ul></li><li class="dropdown-item"><h4>
          机器学习
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/artificial-intelligence/" class="nav-link">
  人工智能
</a></li><li class="dropdown-subitem"><a href="/deep-learning/" class="nav-link">
  深度学习
</a></li><li class="dropdown-subitem"><a href="/recommender-systems/" class="nav-link">
  推荐系统
</a></li><li class="dropdown-subitem"><a href="/quantitative-methods-for-DA-AI/" class="nav-link">
  数据分析与人工智能定量分析
</a></li></ul></li></ul></div></div><div class="nav-item"><a href="https://www.github.com/ZweiRm" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://gitee.com/zweirm/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  码云
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="/about/" class="nav-link">
  关于
</a></div> <a href="https://github.com/ZweiRm/localhost-8080.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    查看源码
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="笔记" class="dropdown-title"><span class="title">笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="笔记" class="mobile-dropdown-title"><span class="title">笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/java/" class="nav-link router-link-active">
  Java
</a></li><li class="dropdown-item"><!----> <a href="/hello-world/" class="nav-link">
  杂谈
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="施工中笔记" class="dropdown-title"><span class="title">施工中笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="施工中笔记" class="mobile-dropdown-title"><span class="title">施工中笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          编程语言
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/kotlin/" class="nav-link">
  Kotlin
</a></li><li class="dropdown-subitem"><a href="/python/" class="nav-link">
  Python
</a></li></ul></li><li class="dropdown-item"><h4>
          后端开发技术
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/web/" class="nav-link">
  Web
</a></li><li class="dropdown-subitem"><a href="/spring/" class="nav-link">
  Spring
</a></li><li class="dropdown-subitem"><a href="/mysql/" class="nav-link">
  MySQL
</a></li><li class="dropdown-subitem"><a href="/redis/" class="nav-link">
  Redis
</a></li><li class="dropdown-subitem"><a href="/big-data/" class="nav-link">
  大数据
</a></li></ul></li><li class="dropdown-item"><h4>
          学科基础
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/software-engineering/" class="nav-link">
  软件工程
</a></li><li class="dropdown-subitem"><a href="/algorithm/" class="nav-link">
  算法
</a></li></ul></li><li class="dropdown-item"><h4>
          机器学习
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/artificial-intelligence/" class="nav-link">
  人工智能
</a></li><li class="dropdown-subitem"><a href="/deep-learning/" class="nav-link">
  深度学习
</a></li><li class="dropdown-subitem"><a href="/recommender-systems/" class="nav-link">
  推荐系统
</a></li><li class="dropdown-subitem"><a href="/quantitative-methods-for-DA-AI/" class="nav-link">
  数据分析与人工智能定量分析
</a></li></ul></li></ul></div></div><div class="nav-item"><a href="https://www.github.com/ZweiRm" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://gitee.com/zweirm/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  码云
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="/about/" class="nav-link">
  关于
</a></div> <a href="https://github.com/ZweiRm/localhost-8080.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    查看源码
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/java/" aria-current="page" class="sidebar-link">Java 概述</a></li><li><a href="/java/grammars.html" class="sidebar-link">语法</a></li><li><a href="/java/object-oriented.html" class="sidebar-link">面向对象</a></li><li><a href="/java/API-introduction.html" class="sidebar-link">应用程序编程接口</a></li><li><a href="/java/API-lang.html" class="sidebar-link">API-语言基础类库 (Package java.lang)</a></li><li><a href="/java/API-util.html" class="sidebar-link">API-工具类库 (Package java.util)</a></li><li><a href="/java/API-io.html" class="sidebar-link">API-输入/输出类库 (Package java.io)</a></li><li><a href="/java/jvm.html" aria-current="page" class="active sidebar-link">Java 虚拟机</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/java/jvm.html#内存分区" class="sidebar-link">内存分区</a></li><li class="sidebar-sub-header"><a href="/java/jvm.html#垃圾分代回收机制" class="sidebar-link">垃圾分代回收机制</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/java/jvm.html#具体逻辑" class="sidebar-link">具体逻辑</a></li></ul></li><li class="sidebar-sub-header"><a href="/java/jvm.html#类加载机制" class="sidebar-link">类加载机制</a></li><li class="sidebar-sub-header"><a href="/java/jvm.html#对象操作机制" class="sidebar-link">对象操作机制</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/java/jvm.html#对象创建" class="sidebar-link">对象创建</a></li></ul></li></ul></li><li><a href="/java/references.html" class="sidebar-link">参考文献或资料</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="java-虚拟机"><a href="#java-虚拟机" class="header-anchor">#</a> Java 虚拟机</h1> <p>Java 中使用范围最广的虚拟机就是 HotSpot 虚拟机，这里介绍相关的知识。</p> <h2 id="内存分区"><a href="#内存分区" class="header-anchor">#</a> 内存分区</h2> <p><img src="/img/%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B.png" alt="内存分区"></p> <ul><li><p>程序计数器<br>
是寄存器，负责程序计数和任务调度。<br>
虚拟机中的字节码解释器通过改变程序计数器来依次读取指令，以此实现代码流程控制。<br>
在多线程情况下，程序计数器记录当前线程执行位置，当线程切换时可以获得运行位置信息。<br>
生命周期随着线程的创建而创建，随着线程的结束而死亡。</p></li> <li><p>本地方法栈<br>
描述本地（原生）方法执行的内存模型。<br>
本地方法被执行的时候，在本地方法栈会创建一个栈帧，用于存放该本地方法的局部变量表、操作数栈、动态链接、出口信息。<br>
可能会出现 StackOverFlowError 和 OutOfMemoryError.</p></li> <li><p>栈内存（虚拟机栈）<br>
描述 Java 方法（字节码）执行的内存模型，每次方法调用的数据都是通过栈传递的。<br>
由一个个栈帧组成，而每个栈帧中都拥有：局部变量表、操作数栈、动态链接、方法出口信息。<br>
其中最重要的是局部变量表，它主要存放编译器可知的各种数据类型和对象引用。<br>
每一次函数调用都会有一个对应的栈帧被压入 Java 栈，每一个函数调用结束或抛出异常后，都会有一个栈帧被弹出。<br>
StackOverFlowError：若 Java 虚拟机栈的内存大小不允许动态扩展，那么当线程请求栈的深度超过当前 Java 虚拟机栈的最大深度的时候，就抛出 StackOverFlowError 错误。<br>
OutOfMemoryError： Java 虚拟机栈的内存大小可以动态扩展， 如果虚拟机在动态扩展栈时无法申请到足够的内存空间，则抛出OutOfMemoryError 错误。</p></li> <li><p>堆内存<br>
存储对象（对象生命周期结束后被 <code>GC</code> 回收，堆也被成为 GC 堆），对象实例和数组会被分配在这里。<br>
堆内存分为：新生代，老年代和永久代。其中新生代包括伊甸园区（Eden）和两个幸存区（Survivor, S0, S1）<br>
可能会出现 OutOfMemoryError, 具体还分为 GC Overhead Limit Exceeded, Java heap space 等情形。</p></li> <li><p>方法区<br>
存储类的信息（已被虚拟机加载的类信息、常量、静态变量、即时编译器编译后的代码等数据）<br>
虽然 Java 虚拟机规范把方法区描述为堆的一个逻辑部分，但是它却有一个别名叫做 Non-Heap（非堆），目的应该是与 Java 堆区分开来。<br>
方法区和永久代的关系很像 Java 中接口和类的关系，类实现了接口。而永久代就是 HotSpot 虚拟机对虚拟机规范中方法区的一种实现方式。<br>
方法区溢出会报 <code>OutOfMemoryError</code> 错误<br>
方法区中垃圾回收行为很少出现，可以用以下命令对该分区大小进行调节：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token operator">-</span>XX<span class="token operator">:</span><span class="token class-name">PermSize</span><span class="token operator">=</span><span class="token class-name">N</span> <span class="token comment">//方法区 (永久代) 初始大小</span>
<span class="token operator">-</span>XX<span class="token operator">:</span><span class="token class-name">MaxPermSize</span><span class="token operator">=</span><span class="token class-name">N</span> <span class="token comment">//方法区 (永久代) 最大大小,超过这个值将会抛出 OutOfMemoryError</span>
</code></pre></div><p>其中：</p> <ul><li><p>静态区<br>
存储静态属性和静态方法<br>
静态属性存储在此区后自动赋默认值</p></li> <li><p>静态常量池<br>
存储类成员属性和成员方法信息</p></li> <li><p>运行时常量池<br>
存储计算机常量和被 <code>final</code> 修饰的常量副本
逻辑包含字符串常量池存放在方法区, 此时 hotspot 虚拟机对方法区的实现为永久代。<span class="badge error" style="vertical-align:top;" data-v-15b7b770>Java 7.0-</span><br>
运行时常量池剩下的东西还在方法区（永久代）中，但字符串常量池被从方法区拿到了堆中。<span class="badge warning" style="vertical-align:top;" data-v-15b7b770>Java 7.0</span><br>
移除了永久代而用元空间取代, 这时候字符串常量池还在堆, 运行时常量池还在方法区, 只不过方法区的实现从永久代变成了元空间。<span class="badge tip" style="vertical-align:top;" data-v-15b7b770>Java 8.0+</span></p></li></ul></li> <li><p>直接内存<br>
直接内存并不是虚拟机运行时数据区的一部分，也不是虚拟机规范中定义的内存区域，但是这部分内存也被频繁地使用。<br>
可能导致 OutOfMemoryError.<br>
JDK1.4 中新加入的 NIO(New Input/Output) 类，引入了一种基于通道（Channel）与缓存区（Buffer）的 I/O 方式，它可以直接使用 Native 函数库直接分配堆外内存，然后通过一个存储在 Java 堆中的 DirectByteBuffer 对象作为这块内存的引用进行操作。这样就能在一些场景中显著提高性能，因为避免了在 Java 堆和 Native 堆之间来回复制数据。<span class="badge tip" style="vertical-align:top;" data-v-15b7b770>Java 1.4+</span></p></li></ul> <p>其中堆内存、方法区与直接内存是所有线程共享的，而栈内存（虚拟机栈）、本地方法栈与程序计数器是每个线程独有的。</p> <p>在Java 8 后，虚拟机对内存分配有了更新<span class="badge tip" style="vertical-align:top;" data-v-15b7b770>Java 8.0+</span>：<br> <img src="/img/%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B1_8.png" alt="内存模型 1.8">
在 Java 8 之后，通过合并 HotSpot 与 JRockit 虚拟机，永久代被元空间代替，而元空间使用直接内存。<br>
使用命令来调节元空间大小：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token operator">-</span>XX<span class="token operator">:</span><span class="token class-name">MetaspaceSize</span><span class="token operator">=</span><span class="token class-name">N</span> <span class="token comment">//设置 Metaspace 的初始（和最小大小）</span>
<span class="token operator">-</span>XX<span class="token operator">:</span><span class="token class-name">MaxMetaspaceSize</span><span class="token operator">=</span><span class="token class-name">N</span> <span class="token comment">//设置 Metaspace 的最大大小</span>
</code></pre></div><p>MetaspaceSize 默认值为 unlimited，意味着它只受系统内存的限制；MetaspaceSize 调整标志定义元空间的初始大小，如果未指定此标志，则 Metaspace 将根据运行时的应用程序需求动态地重新调整大小。<br>
元空间里面存放的是类的元数据，通过使用元空间而不是永久代来增加可加载类的数量。（仅受机器实际可用空间限制）</p> <h2 id="垃圾分代回收机制"><a href="#垃圾分代回收机制" class="header-anchor">#</a> 垃圾分代回收机制</h2> <p>对象在堆内存中存储。当对象在使用完成后，会在某个不定的时刻被垃圾回收器 <code>GC</code> 解析。<br>
值得注意的是：<strong>垃圾回收过程无法手动控制</strong>。<br>
基本逻辑：</p> <ul><li>堆内存分为<strong>新生代区</strong>，<strong>老年代区</strong>和<strong>永久代</strong>。</li> <li>新生代区分为<strong>伊甸园区</strong>和两个<strong>幸存区</strong>。</li> <li>幸存区包括两个部分，S0(From) 和 S1(To).</li> <li>一个新创建的对象会被生成在伊甸园区，若在伊甸园区的对象经过一次回收过程仍然存活，则被移动到幸存区。</li> <li>幸存区的回收扫描频率略低于伊甸园区。在幸存区经过多次扫描，若对象仍然存活，则被移动到老年代区。</li> <li>老年代区的回收扫描频率会远远低于新生代区。</li> <li>当老年代区中的对象被回收时，会导致程序卡顿甚至崩溃。</li> <li>发生在新生代区的垃圾回收称为<strong>初代回收 (Minor GC)</strong>.</li> <li>发生在老年代区的垃圾回收称为<strong>完全回收 (Full GC)</strong>.</li></ul> <h3 id="具体逻辑"><a href="#具体逻辑" class="header-anchor">#</a> 具体逻辑</h3> <p><strong>一般情况</strong></p> <ul><li>对象在伊甸园区分配</li> <li>伊甸园区垃圾回收后仍然存活的对象进入 S0 或 S1，其年龄变为 1</li> <li>每轮垃圾回收后仍然存活的对象年龄加 1</li> <li>当年龄大于 15 （默认情况）的对象转移到老年代<br> <code>-XX:MaxTenuringThreshold</code> 设定阈值年龄大小；<br> <code>-XX:+PrintTenuringDistribution</code> 打印当前次垃圾回收后阈值年龄。<br>
动态年龄阈值计算机制：<br>
虚拟机遍历所有对象统计它们的年龄，按小到大对年龄出现频率进行累积计算。当某年龄开始累积对象总大小超过幸存区容量一半时，取该年龄和 MaxTenuringThreshold 中更小的作为新的阈值年龄。</li> <li>若某次垃圾回收后伊甸园区和 S0 区被清空，则 S1 与 S0 交换角色。</li> <li>若某次垃圾回收后 S0 区空间不够但某些对象还没有达到进入老年代条件，无法存下的部分提前进入老年代。（分配担保机制）</li></ul> <h2 id="类加载机制"><a href="#类加载机制" class="header-anchor">#</a> 类加载机制</h2> <h2 id="对象操作机制"><a href="#对象操作机制" class="header-anchor">#</a> 对象操作机制</h2> <h3 id="对象创建"><a href="#对象创建" class="header-anchor">#</a> 对象创建</h3> <p>当 JVM 遇到需要通过 <code>new</code> 创建对象时：</p> <ol><li>类加载检查</li> <li>分配内存</li> <li>初始化值</li> <li>设置对象头</li> <li>执行 <code>init</code> 方法</li></ol></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/ZweiRm/localhost-8080.github.io/edit/master/docs/java/jvm.md" target="_blank" rel="noopener noreferrer">帮助我改善此页面！</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2022/3/10 下午10:46:02</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/java/API-io.html" class="prev">
        API-输入/输出类库 (Package java.io)
      </a></span> <span class="next"><a href="/java/references.html">
        参考文献或资料
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----><div></div></div></div>
    <script src="/assets/js/app.5cefb728.js" defer></script><script src="/assets/js/3.5e213994.js" defer></script><script src="/assets/js/38.f75bb434.js" defer></script><script src="/assets/js/6.99f29953.js" defer></script><script src="/assets/js/5.612dc22d.js" defer></script>
  </body>
</html>
